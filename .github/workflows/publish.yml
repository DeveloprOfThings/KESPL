name: Publish
on:
  workflow_dispatch:
  release:
    types: [released, prereleased]

# Added permissions needed to upload releases and push the Package.swift update
permissions:
  contents: write
  packages: write

jobs:
  publish:
    name: Release build and publish
    runs-on: macOS-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 21
          cache: 'gradle'

      - name: Extract Project Metadata
        id: metadata
        run: |
          # Grabs VERSION_NAME and GROUP from gradle.properties
          VERSION=$(grep "VERSION_NAME" gradle.properties | cut -d'=' -f2 | xargs)
          GROUP=$(grep "GROUP" gradle.properties | cut -d'=' -f2 | xargs)
          GROUP_PATH=$(echo $GROUP | tr '.' '/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "group_path=$GROUP_PATH" >> $GITHUB_OUTPUT

      - name: Check if version already exists
        run: |
          VERSION=${{ steps.metadata.outputs.version }}
          GROUP_PATH=${{ steps.metadata.outputs.group_path }}
          
          # We check the 'kespl' module. If it exists, we stop.
          STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://repo1.maven.org/maven2/$GROUP_PATH/kespl/$VERSION/kespl-$VERSION.pom)
          
          if [ "$STATUS_CODE" -eq 200 ]; then
            echo "::error::Version $VERSION already exists on Maven Central. Update VERSION_NAME before publishing."
            exit 1
          else
            echo "Version $VERSION is available for publishing."
          fi

       # NEW: Create a GitHub Release. KMMBridge needs this to host the iOS binary zip.
      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.metadata.outputs.version }}
          # If triggered by a GH Release, it uses that; if dispatch, it creates a new one
          draft: false
          prerelease: false

      - name: Publish to MavenCentral
        # This publishes all modules (kespl and kespl-callbacks)
        run: ./gradlew publishAllPublicationsToMavenCentralRepository kmmBridgePublish --no-configuration-cache
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyId: ${{ secrets.SIGNING_KEY_ID }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.SIGNING_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_KEY_CONTENTS }}
          # KMMBridge specific env variables
          GITHUB_PUBLISH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_GRADLE_PROJECT_githubReleaseId: ${{ steps.create_release.outputs.id }}

      - name: Generate Summary
        if: success()
        run: |
          echo "### ðŸš€ Successfully Published!" >> $GITHUB_STEP_SUMMARY
          echo "Version: \`${{ steps.metadata.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "Modules: \`kespl\`, \`kespl-callbacks\`" >> $GITHUB_STEP_SUMMARY
          echo "It may take 15-30 minutes for the artifacts to appear on [Maven Central Search](https://central.sonatype.com/)." >> $GITHUB_STEP_SUMMARY